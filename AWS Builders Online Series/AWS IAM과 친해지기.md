## AWS IAM과 친해지기

#### Why security?

- AWS를 사용하는 방법

  - Console 기반 작업 

    - 쉽게 시작할 수 있다. 
    - 반복 작업에 적합하지 않고, 시간이 오래 걸린다. 

  - Script 기반 작업 

    - 반복 작업에 적합하고, 원하는 항목에 대한 수정이 용이하다.
    - 리소스의 준비 상태 확인이 어렵고, 문제 발생 시 복원이 어렵다.

  - 프로비저닝 엔진 사용

    - 자동화 구현에 용이하고, 반복 작업에 적합하며, 에러 발생 시 원복이 쉽다.
    - 최초 구현이 복잡하다.

  - DOM 기반 작업

    - 코드 기반, 원하는 형상에 대한 정의

    - 초기 코딩이 복잡하다.

      

- Everything API

  위의 어떤 방법을 사용하든, 결국에는 다 API로 프로젝션된다.

  클라이언트가 AWS로 보내는 조회/업데이트/생성/삭제 요청은 모두 API로 이루어진다.

  AWS 자원들끼리 주고받는 요청과 응답도 모두 API 형태를 띄게 된다.

  

- Shared Responsibility Model

  AWS가 제공하는 클라우드의 보안은 AWS가 책임을 지고, 그 위에 올라가는 데이터 또는 애플리케이션의 보안 즉, 클라우드 위의 보안은 고객이 책임져야 한다.



#### AWS IAM(Identity and Access Management)

- AWS 전반에 걸쳐 권한을 통제하는 서비스.

  - `Identity` : AWS로 요청을 할 수 있는 보안주체(Principal)를 AWS 어카운트 내에 만들어 준다.

  - `Access Management` : 누가 어떤 리소스들에 대해 어떤 권한을 가지는지 정의하는 도구로 동작한다.

    

- 접근 제어

  - 인증 : 클라이언트가 자신이 주장하는 사용자와 같은 사용자인지 확인하는 과정

  - 인가 : 클라이언트가 하고자 하는 작업이 해당 클라이언트에게 허가된 작업인지를 확인해 권한을 부여하는 과정

    

- AWS IAM Role

  - 정의된 권한 범위 내 AWS API를 사용할 수 있는 임시 자격 증명(자동으로 로테이션)

  - 장기 Credential을 설정해서 사용하는 것보다 훨씬 안전

  - IAM Role를 사용하면 사용자 권한을 공유하거나 매번 필요한 권한 부여 불 필요

  - IAM USER가 아닌 다른 주체에게 임시 권한을 주기 위해 사용할 수도 있다.

  - Cross Account 상황에서도 Role을 사용해서 더 안전하게 구현할 수 있다.

  - 이 임시 Credential을 발급받아 역할을 사용하는 걸 `Assume` 이라고 한다.

    

- AWS에서의 인가

  - 모든 AWS 서비스는 **접근제어 정책**을 기반으로 인가됨

  - 매 API 호출 시, 적용된 정책을 통해 인가 수행

  - 정책은 IAM 역할/사용자/그룹, AWS 리소스, 임시 자격증명 세션, OU 등에 적용할 수 있음

  - AWS 정책은 기본 디폴트가 **Deny**이고, **명시적 Allow < 명시적 Deny** 의 우선순위를 가지고 있다.

    

- 요청의 성공 조건

  제출된 요청이 성공하기 위해서는,

  1. IAM 보안 주체의 적법한 서명값이 포함되어 있고(인증),
  2. 정책(Policy)에 의해 해당 요청이 정확하게 인가되어야 한다.

  모든 요청은 인증과 인가의 과정을 거치게 된다. (AND 조건)

  

- IAM 정책의 종류

  - Identity-based Policy : 요청하는 주체에게 연결하는 정책

    ```
    Effect: Allow
    Action: s3.GetObject
    Resource: *
    ```

  - Resource-based Policy : 요청을 받는 리소스에 연결이 되는 정책. Principal 구문이 추가로 들어감 (해당 리소스에 요청을 전달할 수 있는 보안주체를 적어줌)

    ```
    Effect: Deny
    Principal: *
    Action: s3:GetObject
    Resource: *
    ```



#### AWS IAM Best practice

- 루트 잠그기

  루트 계정은 

  1. 계정을 생성할 때
  2. 첫 번쨰 IAM 사용자를 만들 때

  이 두 가지 경우를 제외하고는 사용하지 않는 것이 좋다. 아예 키를 삭제하는 것을 권장

  루트 로그인을 위해서는 추가적인 인증 체계인 MFA를 사용하는 것을 권장한다.

  

- IAM 사용자 관리

  - 실제 사용자와 IAM 사용자는 1:1 매핑이 되어야 한다. 

    불필요한 권한이 크게 주어지게 되고, 보안 사고가 났을 때 누가 한지 판단하기 어렵기 때문

  - 비슷한 권한을 가진 여러 명의 IAM 사용자가 있을 경우

    - IAM group을 이용해 관리포인트를 줄인다.
    
    - Permission Boundary를 설정해 그룹에 속한 IAM 사용자가 가질 수 있는 Max 권한을 제어하는 것이 좋다.
    
      

- 최소 권한 부여
  - IAM의 Access Advisor 활용
    - 정책에 포함된 각 서비스를 실제 보안주체가 언제 마지막으로 접근했는지 추적
    - 보안 주체에게 불필요한 권한이 무엇인지 알 수 있음
    - S3와 같은 서비스는 액션 단위로도 Access Advisor를 활용할 수 있다.



#### AWS IAM advanced

계정 전반의 활동을 모니터링하기 위해서 IAM의 이해는 필수적이다.

IAM 활동 감사와 관련된 핵심적인 서비스들

- AWS CloudTrail
  - AWS의 API 로깅 서비스
  - 모든 활동이 API로 이루어지는 AWS 환경 안에서 거의 모든 감사 활동에 있어 핵심적인 베이스 데이터가 된다. (누가, 언제, 무엇을 어디서 어떻게 했는지)
  - 무언가를 예방하기는 어렵지만, 문제가 발생했을 때 이슈의 경위나 원인을 파악하고 트러블슈팅을 위해 필수적인 서비스
- AWS IAM Access analyzer
  - Public 혹은 Cross-Account access를 검사
  - 외부 엔티티와 공유되는 리소스를 식별할 수 있다.
  - 사용자 지정 규칙을 통해 스캔 결과에 관한 알림에 자동으로 응답하도록 구성할 수 있다.
- Amazon GuardDuty
  - 클라우드 환경에 최적화되어있는 위협탐지 서비스
  - 다양한 해킹시도나 보안 위협을 탐지해준다.
  - EC2유형, S3 유형, IAM 유형으로 나뉨
  - IAM과 관련된 명백한 위협활동이나 비정상적 활동을 사용자가 빠르게 탐지할 수 있도록 도와준다.
- Security Hub
  - AWS 환경 전반에 대한 보안 및 규정 준수 현황에 대한 정보를 제공하는 통합 대시보드 서비스
  - IAM 관련 보안 이슈를 포함한 다양한 이슈를 통합적으로 관리

